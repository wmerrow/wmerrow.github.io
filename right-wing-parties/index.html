
<!DOCTYPE html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<style>

body{
  max-width: 900px;
  margin: 0px auto;
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
}

#bylineContainer {
  margin-bottom: 30px;
}

.byline {
  font-size: 14px;
  color: #aaaaaa;
  margin-top: 3px;
  margin-bottom: 3px;
}

.subtitle {
  font-size: 14px;
  fill: #555555;
  margin-top: 5px;
  margin-bottom: 5px;
  font-style: italic;
}

#last {
  margin-bottom: 300px;
}

#container{
  position: relative;
}

#sections{
  width: 420px;
  pointer-events: none;
}

#sections > div{
  background: white;
  opacity: .2;
  margin-bottom: 200px;
}
#sections > div:last-child{
  margin-bottom: 30px;
}
#sections > div.graph-scroll-active{
  opacity: 1;
}

#graph{
  margin-left: 40px;
  width: 420px;
  position: -webkit-sticky;
  position: sticky;
  top: 0px;
  float: right;
}

@media (max-width: 2000px)  {

h1{
  margin-bottom: 30px;
  margin-top: 50px;
}

p{
  font-size: 18px;
}

.content-well {
  max-width: 650px;
  margin: auto;
}

  #graph{
    width: 100%;
    margin-left: 0px;
    float: none;
  }

  #sections{
    width: auto;
    position: relative;
    margin: 0px auto;
  }

  #sections > div{
    background: rgba(255,255,255,.94);
    padding: 10px;
    border-top: 1px solid #bbbbbb;
    border-bottom: 1px solid #bbbbbb;
    margin-bottom: 80vh;
  }

  pre{
    overflow: hidden;
  }

}

.mono{
  font-family: monospace;
}

svg{
  background-color: #ffffff;
}

.partyLabel {
  font-size: 13px;
  text-anchor: end;
  font-weight: bold;
}

.countryLabel {
  font-size: 10px;
  text-anchor: end;
  fill: #999999;
}

.calloutText {
  font-family: sans-serif;
  font-size: 13px;
  font-weight: bold;
  text-anchor: start;
}

.calloutLine {
  stroke: #000000;
  stroke-width: 1;
}

.plotTitle {
  font-size: 16px;
  font-weight: bold;
  text-anchor: middle;
}

.voteTitle {
  font-size: 16px;
  font-weight: bold;
}

.bubbleTitle {
  font-size: 20px;
  font-weight: bold;
}

.voteLabel {
  font-size: 11px;
  text-anchor: start;
}

.yearLabel {
  font-size: 11px;
  text-anchor: middle;
}

.line {
  stroke-width: 0.5;
  stroke: #aaaaaa;
}

.arrow {
  stroke-width: 5;
}

.arrowOuter {
  stroke-width: 6;
}

.arrowInner {
  stroke-width: 4;
  stroke: #ffffff;
}

.arrowRect {
  fill: #ffffff;
  stroke: #aaaaaa;
}

.tooltipParty {
  font-family: sans-serif;
  font-size: 13px;
  font-weight: bold;
  text-anchor: middle;
}

.tooltipCountry {
  font-family: sans-serif;
  font-size: 10px;
  text-anchor: middle;
  fill: #999999;
}

.tooltipYear {
  font-size: 11px;
  text-anchor: middle;
}

.halo {
  fill: #ffffff;
  stroke: #ffffff;
  stroke-width: 5px;
  stroke-linejoin: round;
}

.axis text {
  font: 13px sans-serif;
  fill: #555555;
  /*text-transform: uppercase;*/
}

.rangeAxis text {
  font: 11px sans-serif;
  fill: #999999;
}

/*.domain path {
  stroke: #555555;
}*/

.tick line {
  stroke: #aaaaaa;
}

.filledDot {
  height: 6px;
  width: 6px;
  background-color: #000000;
  border: 0.5px solid #000000;
  border-radius: 50%;
  display: inline-block;
  margin-bottom: 3px;
}

.emptyDot {
  height: 6px;
  width: 6px;
  background-color: #ffffff;
  border: 0.5px solid #000000;
  border-radius: 50%;
  display: inline-block;
  margin-bottom: 3px;
}

#linkPar {
  pointer-events: auto;
}

img {
  width: 100%;
  margin: 0px;
  margin-top: 100px;
}

figcaption {
  font-size: 11px;
  color: #aaaaaa;
/*  margin-top: 3px;
  margin-bottom: 3px;*/
}

figure {
  margin: 0px;
}

.attribution {
  font-style: italic;
}


</style>


<div class="content-well">
  <figure>
    <img src="media/hero.jpg" alt="An image of Marine Le Pen at a podium in front of a rallying crowd.">
    <figcaption id="caption">Marine Le Pen at a meeting of the National Front in 2012. <span class="attribution">Blandine Le Cain / Flickr.</span></figcaption>
  </figure>
  <h1>Anti-Immigrant Political Parties Are Varied and Evolving, New Data Shows</h1>
  <div id="bylineContainer">
    <p class="byline">By Will Merrow</p>
    <p class="byline">Data Journalism Independent Study</p>
    <p class="byline">December 2, 2020</p>
  </div>
  <p>In the last few years, the Republican Party's stance on immigration has aligned with far-right parties like Marine Le Pen’s National Front, according to new research which tracks parties’ positions over time.</p>
  <p>With President Trump’s takeover in 2016, Republicans' immigration positions moved sharply to the right. Over the same time period, Le Pen’s party, which has roots in Holocaust denial and islamophobia, moderated some of its positions, and as of 2019 actually scored to the left of Republicans on immigration.</p>
  <p>As a way to quantify where political parties stand on policy issues, researchers at the University of Gothenburg in Sweden have created a dataset from the assessments of hundreds of country experts, allowing comparison of political parties from around the world.
  </p>
</div>

<div id='container' class='container-1'>
  <div id='graph'></div>
  <div id='sections'>
    
    <div>
      <div class="content-well">
        <p>Looking just at parties in the largest countries in Western Europe - France, Germany, Italy, the Netherlands, Spain, and the United Kingdom - we can see that both Republicans and Democrats are right of center in their immigration views.</p>
      </div>
    </div>

    <div>
      <div class="content-well">
        <p>Republicans are among the most far right, although fringe parties in Italy, the Netherlands, and Spain have more extreme views.</p>
        <p id="linkPar">The main issue driving right wing parties' support is immigration, <a href="https://onlinelibrary.wiley.com/doi/full/10.1111/1467-923X.12765" target="_blank">according to political science research</a>. It has been the defining issue of Le Pen's party, and she has called for "putting a stop" to it, targeting lower-income countries in particular. In Trump's speech announcing his run for president, it was his remark that Mexico is "bringing drugs, crime, and rapists" along with calls for a border wall that most defined his candidacy.</p>
      </div>
    </div>

    <div>
      <div class="content-well">
        <p>Looking at the most far-right parties in these countries, the Republicans and the Conservatives in the UK were the most successful in the last elections, while the other parties failed to break 20 percent of the vote (the data goes up to 2019, so does not include the 2020 election in the U.S.) </p>
        <p>These small vote shares are nonetheless significant, as the parliamentary systems in Europe mean they still translate into seats in the legislature or a role in a coalition government. In 2017, Le Pen lost the French presidential election, but not before forcing a one-on-one runoff against the ultimate winner, Emmanuel Macron.</p>
      </div>
    </div>

    <div>
      <div class="content-well">
        <p>The shifts in recent years are significant. In this graphic, filled dots &nbsp;<span class="filledDot"></span>&nbsp; show parties' positions in the most recent election, and white dots &nbsp;<span class="emptyDot"></span>&nbsp; show positions in previous elections going back to 2012.</p>
        <p>The Republican Party has exhibited the largest change in its immigration views, moving far to the right. Le Pen’s National Front and the Alternative for Germany both moved somewhat left, while the Conservatives moved right and then tacked left.</p>
      </div>
    </div>

    <div>
      <div class="content-well">
        <p>On the economy, the parties’ views are varied. Here, a more right-leaning score means supporting privatization, lower taxes, and and lower spending. There is less movement than on immigration, and the Republican Party's score on economic issues is unchanged since 2012.</p>
        <p>Immigration may be the defining issue for these parties and a main reason for their voters’ support, but they have also enacted major economic changes, such as the UK's Conservatives pushing through Brexit, and Republican’s 2017 tax legislation which lowered taxes for corporations and wealthy Americans in particular.</p>
      </div>
    </div>

    <div>
      <div class="content-well">
        <p>The dataset also includes parties’ support for democratic norms, based on metrics such as tolerance of political violence and respect for opponents. The numbers are ominous: five of the eight parties have become more authoritarian, and none have become more democratic.</p>
        <p>The Republicans and Conservatives show dramatic shifts, having moved significantly towards the authoritarian end of the scale. Some have remained more committed to democracy, such as the anti-immigrant Party for Freedom in the Netherlands, but most are outside the norm.</p>
        <p>But just how far outside the norm are they?</p>
      </div>
    </div>

    <div>
      <div class="content-well">
        <p>To answer this question, we can compare them with the other parties...</p>
      </div>
    </div>

    <div>
      <div class="content-well">
        <p>...and see that the anti-immigration parties are almost alone in their authoritarian tendencies. Nearly every party that leans authoritarian also leans right on immigration.</p>
        <p>Notably, the data is as of 2019, so doesn’t yet reflect the Republican Party’s unfounded claims of voter fraud and other anti-democratic behavior in 2020. With the U.S. election concluded, the next battles over immigration and democracy will be in Europe.</p>
      </div>
    </div>

  </div>

</div>

<div class="content-well">
  <p class="byline" id="last">Data source: The V-Party dataset from the Varieties of Democracy Institute at the University of Gothenburg, Sweden.</p>
</div>


<script src="d3v4+jetpack.js"></script>
<script src="graph-scroll.js"></script>
<script>

d3.queue()
.defer(d3.csv, "data/parties.csv")
.defer(d3.csv, "data/parties_first-last.csv")
.await(function(error, data_all, data_fe_le) {
    if (error) throw error;

// d3.csv('data/parties.csv', function (data_all) {
  console.log(data_all);
  console.log(data_fe_le);

  // DATASETS

  // create data for just parties that were far right on immigration (fri) in last election, keeping all years
  var data_all_fri = data_all
  	.filter(({is_fri_le}) => is_fri_le === "TRUE");
  console.log(data_all_fri); 

  // create data for just parties that were far right on immigration (fri) in last election, limited to last election year
  var data_le_fri = data_all
  	.filter(({is_last_election}) => is_last_election === "TRUE")
  	.filter(({is_fri_le}) => is_fri_le === "TRUE");
  console.log(data_le_fri);

  // same for non-fri parties
  var data_le_not_fri = data_all
  	.filter(({is_last_election}) => is_last_election === "TRUE")
  	.filter(({is_fri_le}) => is_fri_le === "FALSE");
  console.log(data_le_not_fri);

  // nested by party
  // var data_all_fri_nested = d3.nest()
	 //  .key(function(d){
	 //    return d.v2paenname; // okay to use name since there are no duplicate party names in this dataset
	 //  })
	 //  .entries(data_all_fri);
  // console.log(data_all_fri_nested);


  // CHART LAYOUT

  var width = 900;
  var height = 470;

  var colWidth = width / 4;

  var margin = {
        top: 100,
        right: 90,
        bottom: 15,
        left: 0
      };

  var colMargin = {
        right: 12,
        left: 12
      };

  var initialY = 240;


  // SCALES

  // sqrt scale so data value maps to bubble area
  var bubbleSize = d3.scaleSqrt()
        .domain([0, 50])
        .range([0, 17]);


  // scales for x values
  // bubbles immig
  var bubbleImmigX = d3.scaleLinear()
        .domain([5, -5])
        .range([margin.left, width - margin.right]);
  // bubbles illib
  var bubbleIllibY = d3.scaleLinear()
        .domain([0, 1])
        .range([margin.top, height - margin.bottom]);
  // range plot immig
  var rangeImmigX = d3.scaleLinear()
        .domain([5, -5])
        .range([colMargin.left, colWidth - colMargin.right]);
  // range plot econ
  var rangeEconX = d3.scaleLinear()
        .domain([-5, 5])
        .range([colMargin.left, colWidth - colMargin.right]);
  // range plot illib
  var rangeIllibX = d3.scaleLinear()
        .domain([0, 1])
        .range([colMargin.left, colWidth - colMargin.right]);

  // band scale for y positions in table (sorting by vote share in last election)
  var yScale = d3.scaleBand()
        .domain(data_le_fri.sort(function(a,b) {return d3.ascending(+a.v2pavote, +b.v2pavote);}).map(d => d.v2paid))
        .range([height - margin.bottom, 0 + margin.top]);
        // .paddingInner(.2) 
        // .paddingOuter(.2);

  // color scales

  // immig
  var immigColor = d3.scaleLinear()
	    .domain([-5, 5])
	    .range(['red','blue'])
	    .interpolate(d3.interpolateRgb); //interpolateHsl interpolateHcl interpolateRgb
  // var immigColor = d3.scaleLinear()
  //     .domain([-5, -4, -3, -2, -1, 0, 1, 2, 3, 4, 5])
  //     .range(['#67001f','#b2182b','#d6604d','#f4a582','#fddbc7','#dddddd','#d1e5f0','#92c5de','#4393c3','#2166ac','#053061'])
  //     .interpolate(d3.interpolateRgb); //interpolateHsl interpolateHcl interpolateRgb

  // econ
  var econColor = d3.scaleLinear()
      .domain([5, -5])
      .range(['red','blue'])
      .interpolate(d3.interpolateRgb); //interpolateHsl interpolateHcl interpolateRgb
  // var econColor = d3.scaleLinear()
	 //    .domain([5, 4, 3, 2, 1, 0, -1, -2, -3, -4, -5])
	 //    .range(['#67001f','#b2182b','#d6604d','#f4a582','#fddbc7','#dddddd','#d1e5f0','#92c5de','#4393c3','#2166ac','#053061'])
	 //    .interpolate(d3.interpolateRgb); //interpolateHsl interpolateHcl interpolateRgb

  // illib
  var illibColor = d3.scaleLinear()
      //.domain([0, .1, .2, .3, .4, .5, .6, .7, .8, .9, 1])
      .domain([1, 0])
      .range(['#000000','#aaaaaa'])
      .interpolate(d3.interpolateRgb); //interpolateHsl interpolateHcl interpolateRgb
  // var illibColor = d3.scaleLinear()
	 //    //.domain([0, .1, .2, .3, .4, .5, .6, .7, .8, .9, 1])
	 //    .domain([1, .9, .8, .7, .6, .5, .4, .3, .2, .1, 0])
	 //    .range(['#67001f','#b2182b','#d6604d','#f4a582','#fddbc7','#dddddd','#d1e5f0','#92c5de','#4393c3','#2166ac','#053061'])
	 //    .interpolate(d3.interpolateRgb); //interpolateHsl interpolateHcl interpolateRgb
  
  var red = '#b2182b';
  var lightRed = '#f4a582';

  var yearColor = d3.scaleOrdinal()
      .domain(["TRUE", "FALSE"])
      .range([red, lightRed]);




  // CREATE CHARTS

 // var oldWidth = 0
  function render(){
    
    //// LOGIC FOR MOBILE LAYOUT

    // if (oldWidth == innerWidth) return
    // oldWidth = innerWidth

    // var width = height = d3.select('#graph').node().offsetWidth
    // var r = 40

    // if (innerWidth <= 925){
    //   width = innerWidth
    //   height = innerHeight*.7
    // }

    // return console.log(width, height)

    // add SVG
    var svg = d3.select('#graph').html('')
      .append('svg')
      .attrs({width: width, height: height});

    var xAxis = svg.append("g")
      .attr("transform", "translate(0," + initialY + ")")
      .attr('class', 'axis')
      .attr('id', 'xAxis')
      .call(d3.axisTop(bubbleImmigX)
        .tickSize(7)
        .tickPadding(10)
        .tickValues([-5, 5])
        .tickFormat((function (v) {
              if (v == 5) {
                return 'Pro-immigration'; 
              } else if (v == -5) {
                return 'Anti-immigration'; 
              };
          })));

    var yAxis = svg.append("g")
      .attr("transform", "translate(" + (width - margin.right) + ", 0)")
      .attr('class', 'axis')
      .attr('id', 'yAxis')
      .call(d3.axisRight(bubbleIllibY)
        .tickSize(7)
        .tickPadding(10)
        .tickValues([0, 1])
        .tickFormat((function (v) {
              if (v == 0) {
                return 'Democratic'; 
              } else if (v == 1) {
                return 'Authoritarian'; 
              };
          })));
      

    d3.selectAll(".domain").style('stroke', '#aaaaaa');
    d3.select('#xAxis').selectAll(".tick text").style("text-anchor",function(d,i){ return i%2 ? "start" : "end"});
    //d3.select('.yAxis').selectAll(".tick text").style("text-anchor",function(d,i){ return i%2 ? "start" : "end"});

    // Row labels

    var partyLabels = svg.append("g").selectAll('partyText')
      .data(data_le_fri)
      .enter()
      .append('text')
      .attr('class', 'partyLabel')
      .style('opacity', 0) // hidden to start
      .text(d=> d.v2paenname)
      .attr('x', colWidth * 2)
      .attr('y', initialY);

    var countryLabels = svg.append("g").selectAll('countryText')
      .data(data_le_fri)
      .enter()
      .append('text')
      .attr('class', 'countryLabel')
      .style('opacity', 0) // hidden to start
      .text(d=> d.country_name.toUpperCase())
      .attr('x', colWidth * 2)
      .attr('y', initialY + 15);

    var voteLabels = svg.append("g").selectAll('countryText')
      .data(data_le_fri)
      .enter()
      .append('text')
      .attr('class', 'voteLabel')
      .style('opacity', 0) // hidden to start
      .text(d=> d3.format(".0%")(+d.v2pavote / 100)) // change to pct format
      .attr('x', colWidth * 2)
      .attr('y', initialY + 15);

    var voteTitle = svg
      .append('text')
      .text("Vote Share in Last Election")
      .attr('class', 'voteTitle')
      .attr('x', colWidth + 60) // position in middle of second column
      .attr('y', margin.top - 37);

    var dotSize = 4;

    // range plots

    // lines

    var plot1Lines = svg.append("g").selectAll('line1')
      .data(data_le_fri)
      .enter()
      .append('line')
      .attr('class', 'line')
      .style('opacity', 0) // hidden to start
      .attr('x1', colWidth + colMargin.left)
      .attr('x2', colWidth * 2 - colMargin.right)
      .attr('y1', d=> yScale(d.v2paid))
      .attr('y2', d=> yScale(d.v2paid));

    var plot2Lines = svg.append("g").selectAll('line2')
      .data(data_le_fri)
      .enter()
      .append('line')
      .attr('class', 'line')
      .style('opacity', 0) // hidden to start
      .attr('x1', colWidth * 2 + colMargin.left)
      .attr('x2', colWidth * 3 - colMargin.right)
      .attr('y1', d=> yScale(d.v2paid))
      .attr('y2', d=> yScale(d.v2paid));

     var plot3Lines = svg.append("g").selectAll('line3')
      .data(data_le_fri)
      .enter()
      .append('line')
      .attr('class', 'line')
      .style('opacity', 0) // hidden to start
      .attr('x1', colWidth * 3 + colMargin.left)
      .attr('x2', colWidth * 4 - colMargin.right)
      .attr('y1', d=> yScale(d.v2paid))
      .attr('y2', d=> yScale(d.v2paid));

    // plot arrowRects

    // var plot1Arrows = svg.selectAll('arrow1')
    //   .data(data_fe_le)
    //   .enter()
    //   .append('rect')
    //   .attr('class', 'arrowRect')
    //   .style('opacity', 0) // hidden to start
    //   //.attr('x1', d=> rangeImmigX(+d.v2paimmig_fe) + colWidth)
    //   .attr('x', d=> rangeImmigX(+d.v2paimmig_le) + colWidth - dotSize)
    //   .attr('y', d=> yScale(d.v2paid) - dotSize)
    //   .attr('width', d=> rangeImmigX(+d.v2paimmig_fe) - rangeImmigX(+d.v2paimmig_le) + dotSize*2)
    //   .attr('height', dotSize * 2)
    //   .attr('rx', dotSize);

    // plot arrows outer

    var plot1ArrowsOuter = svg.append("g").selectAll('arrow1')
      .data(data_fe_le)
      .enter()
      .append('line')
      .attr('class', 'arrowOuter')
      .style('opacity', 0) // hidden to start
      .style('stroke', d=> immigColor(+d.v2paimmig_le))
      .attr('x1', d=> rangeImmigX(+d.v2paimmig_fe) + colWidth)
      .attr('x2', d=> rangeImmigX(+d.v2paimmig_le) + colWidth)
      .attr('y1', d=> yScale(d.v2paid))
      .attr('y2', d=> yScale(d.v2paid));

    var plot2ArrowsOuter = svg.append("g").selectAll('arrow2')
      .data(data_fe_le)
      .enter()
      .append('line')
      .attr('class', 'arrowOuter')
      .style('opacity', 0) // hidden to start
      .style('stroke', d=> econColor(+d.v2pariglef_le))
      .attr('x1', d=> rangeEconX(+d.v2pariglef_fe) + colWidth*2)
      .attr('x2', d=> rangeEconX(+d.v2pariglef_le) + colWidth*2)
      .attr('y1', d=> yScale(d.v2paid))
      .attr('y2', d=> yScale(d.v2paid));

    var plot3ArrowsOuter = svg.append("g").selectAll('arrow3')
      .data(data_fe_le)
      .enter()
      .append('line')
      .attr('class', 'arrowOuter')
      .style('opacity', 0) // hidden to start
      .style('stroke', d=> illibColor(+d.v2xpa_illiberal_le))
      .attr('x1', d=> rangeIllibX(+d.v2xpa_illiberal_fe) + colWidth*3)
      .attr('x2', d=> rangeIllibX(+d.v2xpa_illiberal_le) + colWidth*3)
      .attr('y1', d=> yScale(d.v2paid))
      .attr('y2', d=> yScale(d.v2paid));
 
  // plot arrows inner

    var plot1ArrowsInner = svg.append("g").selectAll('arrow1')
      .data(data_fe_le)
      .enter()
      .append('line')
      .attr('class', 'arrowInner')
      .style('opacity', 0) // hidden to start
      .attr('x1', d=> rangeImmigX(+d.v2paimmig_fe) + colWidth)
      .attr('x2', d=> rangeImmigX(+d.v2paimmig_le) + colWidth)
      .attr('y1', d=> yScale(d.v2paid))
      .attr('y2', d=> yScale(d.v2paid));

    var plot2ArrowsInner = svg.append("g").selectAll('arrow2')
      .data(data_fe_le)
      .enter()
      .append('line')
      .attr('class', 'arrowInner')
      .style('opacity', 0) // hidden to start
      .attr('x1', d=> rangeEconX(+d.v2pariglef_fe) + colWidth*2)
      .attr('x2', d=> rangeEconX(+d.v2pariglef_le) + colWidth*2)
      .attr('y1', d=> yScale(d.v2paid))
      .attr('y2', d=> yScale(d.v2paid));

    var plot3ArrowsInner = svg.append("g").selectAll('arrow3')
      .data(data_fe_le)
      .enter()
      .append('line')
      .attr('class', 'arrowInner')
      .style('opacity', 0) // hidden to start
      .attr('x1', d=> rangeIllibX(+d.v2xpa_illiberal_fe) + colWidth*3)
      .attr('x2', d=> rangeIllibX(+d.v2xpa_illiberal_le) + colWidth*3)
      .attr('y1', d=> yScale(d.v2paid))
      .attr('y2', d=> yScale(d.v2paid));   
    // dots

    var plot1Dots = svg.append("g").selectAll('dots1')
      .data(data_all_fri)
      //.filter(function(d) { return +d.year == 2000 })
      .enter()
      .append('circle')
      .attr('cx', d=> rangeImmigX(+d.v2paimmig) + colWidth)
      .attr('cy', d=> yScale(+d.v2paid))
      .attr('r', dotSize)
      // .attr('r', d=> {
      //  if (d.is_last_election == "TRUE") {
      //    return dotSize + 1.5; // make le dots larger
      //  } else {
      //    return dotSize;
      //  }
      // })
      .style('opacity', 0)
      // .style('fill', d=> yearColor(d.is_last_election));
      // .style('fill', red);
     .style('stroke', d=> immigColor(+d.v2paimmig))
     .style('fill', d=> {if (d.is_last_election == "FALSE"){
      return '#ffffff';
     } else {
      return immigColor(+d.v2paimmig);     
     }
   });
  // .on("mouseover", function(event, i) { 
  //       var x = rangeImmigX(data_le_fri.sort(function(a,b) {return d3.descending(+a.v2pavote, +b.v2pavote);})[i].v2paimmig) + colWidth;
  //       d3.select(this)
  //          .style('stroke', '#000000')
  //          .style('stroke-width', '2px');
  //       d3.select("#tooltipYear")
  //          .text(data_all[i].year)           
  //          .style("opacity", 1)
  //          .attr("x", x + colWidth)
  //          .attr("y", yScale(data_le_fri.sort(function(a,b) {return d3.descending(+a.v2pavote, +b.v2pavote);})[i].v2paid) - 20);
  //       console.log(data_all[i]);
  //       console.log(data_all[i].v2paid);
  //       })     
  //      // for some reason "=>" syntax doesn't work with "this" so need to write out "function"
  //     .on("mouseout", function(event, i) { 
  //         d3.select(this)
  //          .style('stroke', '#ffffff')
  //          .style('stroke-width', '0.5px');
  //         d3.select("#tooltipYear")
  //          .style("opacity", 0);
  //       });


    var plot2Dots = svg.append("g").selectAll('dots2')
      .data(data_all_fri)
      //.filter(function(d) { return +d.year == 2000 })
      .enter()
      .append('circle')
      .attr('cx', d=> rangeEconX(+d.v2pariglef) + colWidth * 2)
      .attr('cy', d=> yScale(+d.v2paid))
      .attr('r', dotSize)
      .style('opacity', 0)
      // .style('fill', d=> yearColor(d.is_last_election));
      // .style('fill', red);
     .style('stroke', d=> econColor(+d.v2pariglef))
     .style('fill', d=> {if (d.is_last_election == "FALSE"){
      return '#ffffff';
     } else {
      return econColor(+d.v2pariglef);     
     }
   }); 

    var plot3Dots = svg.append("g").selectAll('dots3')
      .data(data_all_fri)
      //.filter(function(d) { return +d.year == 2000 })
      .enter()
      .append('circle')
      .attr('cx', d=> rangeIllibX(+d.v2xpa_illiberal) + colWidth * 3)
      .attr('cy', d=> yScale(+d.v2paid))
      .attr('r', dotSize)
      .style('opacity', 0)
      // .style('fill', d=> yearColor(d.is_last_election));
      // .style('fill', red);
     .style('stroke', d=> illibColor(+d.v2xpa_illiberal))
     .style('fill', d=> {if (d.is_last_election == "FALSE"){
      return '#ffffff';
     } else {
      return illibColor(+d.v2xpa_illiberal);     
     }
   }); 

    // plot axes

    var plot1Axis = svg.append("g")
      .attr("transform", "translate(" + colWidth + "," + (margin.top - 15) + ")")
      .attr('class', 'rangeAxis')
      .attr('id', 'plot1Axis')
      .call(d3.axisTop(rangeImmigX)
        .tickSize(10)
        .tickValues([-5, 5])
        .tickFormat((function (v) {
              if (v == 5) {
                return 'Support'; 
              } else if (v == -5) {
                return 'Oppose'; 
              };
          })));

    var plot2Axis = svg.append("g")
      .attr("transform", "translate(" + colWidth * 2 + "," + (margin.top - 15) + ")")
      .attr('class', 'rangeAxis')
      .attr('id', 'plot2Axis')
      .call(d3.axisTop(rangeEconX)
        .tickSize(10)
        .tickValues([-5, 5])
        .tickFormat((function (v) {
              if (v == 5) {
                return 'Right'; 
              } else if (v == -5) {
                return 'Left'; 
              };
          })));

    var plot3Axis = svg.append("g")
      .attr("transform", "translate(" + colWidth * 3 + "," + (margin.top - 15) + ")")
      .attr('class', 'rangeAxis')
      .attr('id', 'plot3Axis')
      .call(d3.axisTop(rangeIllibX)
        .tickSize(10)
        .tickValues([1, 0])
        .tickFormat((function (v) {
              if (v == 0) {
                return 'Democratic'; 
              } else if (v == 1) {
                return 'Authoritarian'; 
              };
          })));

    d3.selectAll(".rangeAxis").selectAll('.domain').style('display', 'none');
    d3.selectAll(".rangeAxis").selectAll('line').style('stroke', '#ffffff');

    d3.select("#plot1Axis").selectAll(".tick text").style("text-anchor",function(d,i){ return i%2 ? "start" : "end"});
    d3.select("#plot2Axis").selectAll(".tick text").style("text-anchor",function(d,i){ return i%2 ? "end" : "start"});
    d3.select("#plot3Axis").selectAll(".tick text").style("text-anchor",function(d,i){ return i%2 ? "start" : "end"});

    // plot titles

    var plot1Title = svg
      .append('text')
      .text("Immigration")
      .attr('class', 'plotTitle')
      .attr('x', colWidth * 1.5) // position in middle of second column
      .attr('y', margin.top - 45);

    var plot2Title = svg
      .append('text')
      .text("Economy")
      .attr('class', 'plotTitle')
      .attr('x', colWidth * 2.5) // position in middle of third column
      .attr('y', margin.top - 45);

    var plot3Title = svg
      .append('text')
      .text("Democracy")
      .attr('class', 'plotTitle')
      .attr('x', colWidth * 3.5) // position in middle of fourth column
      .attr('y', margin.top - 45);

    // year labels

    var plot1YearLabels = svg.append("g").selectAll('yearLabels')
      .data(data_le_fri)
      //.filter(function(d) { return +d.year == 2000 })
      .enter()
      .append('text')
      .text(d=> d.year)
      .attr('class', 'yearLabel')
      .attr('x', d=> rangeImmigX(+d.v2paimmig) + colWidth)
      .attr('y', d=> yScale(+d.v2paid) - dotSize - 4)
      .style('opacity', 0);

    var plot2YearLabels = svg.append("g").selectAll('yearLabels')
      .data(data_le_fri)
      //.filter(function(d) { return +d.year == 2000 })
      .enter()
      .append('text')
      .text(d=> d.year)
      .attr('class', 'yearLabel')
      .attr('x', d=> rangeEconX(+d.v2pariglef) + colWidth * 2)
      .attr('y', d=> yScale(+d.v2paid) - dotSize - 4)
      .style('opacity', 0);

    var plot3YearLabels = svg.append("g").selectAll('yearLabels')
      .data(data_le_fri)
      //.filter(function(d) { return +d.year == 2000 })
      .enter()
      .append('text')
      .text(d=> d.year)
      .attr('class', 'yearLabel')
      .attr('x', d=> rangeIllibX(+d.v2xpa_illiberal) + colWidth * 3)
      .attr('y', d=> yScale(+d.v2paid) - dotSize - 4)
      .style('opacity', 0);


    // CALLOUTS

    // IDs of parties to call out
    var callouts = [432, 809, 433];

    // callout party labels
    var calloutLabelsFri = svg.append("g").selectAll('calloutTextFri')
      .data(data_le_fri)
      .enter()
      .append('text')
      .style('display', d=> {if (!callouts.includes(+d.v2paid)) {return 'none';};})
      .attr('class', 'calloutText')
      .style('opacity', 0) // hidden to start
      .text(d=> d.v2paenname)
      .attr('x', 0)
      .attr('y', 0);
    var calloutLabelsNotFri = svg.append("g").selectAll('calloutTextNotFri')
      .data(data_le_not_fri)
      .enter()
      .append('text')
      .style('display', d=> {if (!callouts.includes(+d.v2paid)) {return 'none';};})
      .attr('class', 'calloutText')
      .style('opacity', 0) // hidden to start
      .text(d=> d.v2paenname)
      .attr('x', 0)
      .attr('y', 0);

    // callout party lines
    var calloutLinesFri = svg.append("g").selectAll('calloutLineFri')
      .data(data_le_fri)
      .enter()
      .append('line')
      .style('display', d=> {if (!callouts.includes(+d.v2paid)) {return 'none';};})
      .attr('class', 'calloutLine')
      .style('opacity', 0) // hidden to start
      .attr('x1', 0)
      .attr('y1', 0)
      .attr('x2', 0)
      .attr('y2', 0);
    var calloutLinesNotFri = svg.append("g").selectAll('calloutLineNotFri')
      .data(data_le_not_fri)
      .enter()
      .append('line')
      .style('display', d=> {if (!callouts.includes(+d.v2paid)) {return 'none';};})
      .attr('class', 'calloutLine')
      .style('opacity', 0) // hidden to start
      .attr('x1', 0)
      .attr('y1', 0)
      .attr('x2', 0)
      .attr('y2', 0);


    // BUBBLES (added last so tooltips are on top)
      
    var bubbleTitle = svg
      .append('text')
      .text("Where Parties Stand on Immigration")
      .attr('class', 'bubbleTitle')
      .attr('x', 0) // position in middle of second column
      .attr('y', margin.top - 10);

    var bubbleSubtitle = svg
      .append('text')
      .text("Bubbles represent political parties positioned according to their immigration stance in the last election and sized by vote share.")
      // .text("Bubbles represent political parties positioned according to their immigration stance in the last election and sized according to the party’s vote share. Parties included are those receiving at least 5 percent of the vote in the last election in France, Germany, Italy, the Netherlands, Spain, the United Kingdom, and the United States.")
      .attr('class', 'subtitle')
      .attr('x', 0) // position in middle of second column
      .attr('y', margin.top + 20);

    var bubbles_fri = svg.append("g").selectAll('circle_fri')
      .data(data_le_fri.sort(function(a,b) {return d3.descending(+a.v2pavote, +b.v2pavote);})) // sort bubbles so smallest are on top
      .enter()
      .append('circle')
      .attr('cx', d=> bubbleImmigX(+d.v2paimmig))
      .attr('cy', initialY)
      .attr('r', d=> bubbleSize(+d.v2pavote))
      .style('opacity', 1)
      .style('stroke', '#ffffff')
      .style('stroke-width', '0.5px')
      .style('fill', d=> immigColor(+d.v2paimmig))
      .on("mouseover", function(event, i) { 
        // hide callout labels
        // d3.selectAll('.calloutText')
        //   .style('opacity', 0);
        d3.select(this)
           .style('stroke', '#000000')
           .style('stroke-width', '2px');
        d3.select("#tooltipPartyHalo")
           .text(data_le_fri.sort(function(a,b) {return d3.descending(+a.v2pavote, +b.v2pavote);})[i].v2paenname)           
           .style("opacity", 1)
           .attr("x", this.cx.baseVal.value)
           .attr("y", this.cy.baseVal.value + 35);
        d3.select("#tooltipCountryHalo")
           .text(data_le_fri.sort(function(a,b) {return d3.descending(+a.v2pavote, +b.v2pavote);})[i].country_name.toUpperCase())           
           .style("opacity", 1)
           .attr("x", this.cx.baseVal.value)
           .attr("y", this.cy.baseVal.value + 50);
        d3.select("#tooltipParty")
           .text(data_le_fri.sort(function(a,b) {return d3.descending(+a.v2pavote, +b.v2pavote);})[i].v2paenname)           
           .style("opacity", 1)
           .attr("x", this.cx.baseVal.value)
           .attr("y", this.cy.baseVal.value + 35);
        d3.select("#tooltipCountry")
           .text(data_le_fri.sort(function(a,b) {return d3.descending(+a.v2pavote, +b.v2pavote);})[i].country_name.toUpperCase())           
           .style("opacity", 1)
           .attr("x", this.cx.baseVal.value)
           .attr("y", this.cy.baseVal.value + 50);
        })     
       // for some reason "=>" syntax doesn't work with "this" so need to write out "function"
      .on("mouseout", function(event, i) { 
        // restore callout labels
        // d3.selectAll('.calloutText')
        //   .style('opacity', 1);
          d3.select(this)
           .style('stroke', '#ffffff')
           .style('stroke-width', '0.5px');
          d3.select("#tooltipPartyHalo")
           .style("opacity", 0);
          d3.select("#tooltipCountryHalo")
           .style("opacity", 0);
          d3.select("#tooltipParty")
           .style("opacity", 0);
          d3.select("#tooltipCountry")
           .style("opacity", 0);
        });

    var bubbles_not_fri = svg.append("g").selectAll('circle_not_fri')
      .data(data_le_not_fri.sort(function(a,b) {return d3.descending(+a.v2pavote, +b.v2pavote);})) // sort bubbles so smallest are on top
      .enter()
      .append('circle')
      .attr('cx', d=> bubbleImmigX(+d.v2paimmig))
      .attr('cy', initialY)
      .attr('r', d=> bubbleSize(+d.v2pavote))
      .style('opacity', 1)
      .style('stroke', '#ffffff')
      .style('stroke-width', '0.5px')
      .style('fill', d=> immigColor(+d.v2paimmig))
      .on("mouseover", function(event, i) { 
        // hide callout labels
        // d3.selectAll('.calloutText')
        //   .style('opacity', 0);
        d3.select(this)
           .style('stroke', '#000000')
           .style('stroke-width', '2px');
        d3.select("#tooltipPartyHalo")
           .text(data_le_not_fri.sort(function(a,b) {return d3.descending(+a.v2pavote, +b.v2pavote);})[i].v2paenname)           
           .style("opacity", 1)
           .attr("x", this.cx.baseVal.value)
           .attr("y", this.cy.baseVal.value + 35);
        d3.select("#tooltipCountryHalo")
           .text(data_le_not_fri.sort(function(a,b) {return d3.descending(+a.v2pavote, +b.v2pavote);})[i].country_name.toUpperCase())           
           .style("opacity", 1)
           .attr("x", this.cx.baseVal.value)
           .attr("y", this.cy.baseVal.value + 50);
        d3.select("#tooltipParty")
           .text(data_le_not_fri.sort(function(a,b) {return d3.descending(+a.v2pavote, +b.v2pavote);})[i].v2paenname)           
           .style("opacity", 1)
           .attr("x", this.cx.baseVal.value)
           .attr("y", this.cy.baseVal.value + 35);
        d3.select("#tooltipCountry")
           .text(data_le_not_fri.sort(function(a,b) {return d3.descending(+a.v2pavote, +b.v2pavote);})[i].country_name.toUpperCase())           
           .style("opacity", 1)
           .attr("x", this.cx.baseVal.value)
           .attr("y", this.cy.baseVal.value + 50);
        })     
       // for some reason "=>" syntax doesn't work with "this" so need to write out "function"
      .on("mouseout", function(event, i) { 
        // restore callout labels
        // d3.selectAll('.calloutText')
        //   .style('opacity', 1);
          d3.select(this)
           .style('stroke', '#ffffff')
           .style('stroke-width', '0.5px');
          d3.select("#tooltipPartyHalo")
           .style("opacity", 0);
          d3.select("#tooltipCountryHalo")
           .style("opacity", 0);
          d3.select("#tooltipParty")
           .style("opacity", 0);
          d3.select("#tooltipCountry")
           .style("opacity", 0);
        });

    // TOOLTIPS

    svg.append("text")
      .attr("id", "tooltipPartyHalo")
      .attr('class', 'tooltipParty halo')
      .attr('x', 0)
      .attr('y', 0)
      .style('opacity', 0)
      .text('');
    svg.append("text")
      .attr("id", "tooltipCountryHalo")
      .attr('class', 'tooltipCountry halo')
      .attr('x', 0)
      .attr('y', 0)
      .style('opacity', 0)
      .text('');
    svg.append("text")
      .attr("id", "tooltipParty")
      .attr('class', 'tooltipParty')
      .attr('x', 0)
      .attr('y', 0)
      .style('opacity', 0)
      .text('');
    svg.append("text")
      .attr("id", "tooltipCountry")
      .attr('class', 'tooltipCountry')
      .attr('x', 0)
      .attr('y', 0)
      .style('opacity', 0)
      .text('');
    // svg.append("text")
    //   .attr("id", "tooltipYear")
    //   .attr('x', 0)
    //   .attr('y', 0)
    //   .style('opacity', 0)
    //   .text('');

    // lines
    // var lines = svg.selectAll('line')
    //   .data(data_le_fri)
    //   .enter()
    //   .append('line')
    //   .attr('class', 'line')
    //   .style('opacity', 0) // hidden to start
    //   .attr('x1', 0)
    //   .attr('x2', width)
    //   .attr('y1', d=> yScale(d.v2paid))
    //   .attr('y2', d=> yScale(d.v2paid));





    // first scrollytelling section

    var gs = d3.graphScroll()
        .container(d3.select('.container-1'))
        .graph(d3.selectAll('container-1 #graph'))
        .eventId('uniqueId1')  // namespace for scroll and resize events
        .sections(d3.selectAll('.container-1 #sections > div'))
        // .offset(innerWidth < 900 ? innerHeight - 30 : 200)
        .on('active', function(i){

	    // table for easier read (view with word wrap off)
      //                              0 initial       1 fade        2 vote       3 plot1       4 plot2      5 plot3      6 immig     7 illib scatter
	    var currentX =                  ['v2paimmig',   'v2paimmig',  colWidth*2,  colWidth - colMargin.right,	   colWidth - colMargin.right,	 colWidth - colMargin.right    , 'v2paimmig', 'v2paimmig'][i];
	    var currentY =                  [initialY,      initialY,     'v2paid',    'v2paid',     'v2paid',	   'v2paid',    margin.top, 'v2xpa_illiberal'][i];
      var currentYAxis =              [initialY,      initialY,     initialY,    initialY,     initialY,    initialY,    margin.top, margin.top][i];
      var currentYNotFri =            [initialY,      initialY,     initialY,    initialY,     initialY,    initialY,    margin.top, 'v2xpa_illiberal'][i];
      var currentHoverFri =           ['auto',        'auto',       'none',      'none',       'none',      'none',      'auto',     'auto'][i];
      var currentHoverNotFri =        ['auto',        'none',       'none',      'none',       'none',      'none',      'auto',     'auto'][i];
      var currentColor =              ['v2paimmig',   'v2paimmig',  'v2paimmig', 'v2paimmig',  'v2paimmig', 'v2paimmig','v2paimmig', 'v2xpa_illiberal'][i];
	    var currentOpacityTitle =       [1,             0.05,         0,           0,            0,			      0,           0,          0][i];
      var currentOpacityNotFri =      [1,             0.05,         0,           0,            0,           0,           1,          1][i];
	    var currentOpacityFri =         [1,             1,            1,           0,            0,			      0,           1,          1][i];
      var currentOpacityVote =        [0,             0,            1,           0,            0,           0,           0,          0][i];
	    var currentOpacityLabs =        [0,             0,            1,           1,            1,           1,			     0,          0][i];
      var currentOpacityCallFri =     [1,             1,            0,           0,            0,           0,           1,          1][i];
      var currentOpacityCallNotFri =  [1,             0.05,         0,           0,            0,           0,           1,          1][i];
	    var currentOpacityPlot1 =       [0,             0,            0,           1,            1,           1,			     0,          0][i];
	    var currentOpacityPlot2 =       [0,             0,            0,           0,            1,           1,			     0,          0][i];
	    var currentOpacityPlot3 =       [0,             0,            0,           0,            0,           1,			     0,          0][i];

        bubbles_fri.transition().duration(1000)
            .style('opacity', currentOpacityFri)
            .attr('cx', d=> {
              if (typeof currentX == 'string') {
                return bubbleImmigX(+d[currentX]);
              } else {
                return currentX + 15 + bubbleSize(+d.v2pavote); // includes offset and radius so bubbles will be left-aligned
              }
            })
            .attr('cy', d=> {
              if (currentY == 'v2paid') {
                return yScale(+d[currentY]);
              } else if (currentY == 'v2xpa_illiberal') {
                return bubbleIllibY(+d[currentY]);
              } else {
                return currentY;
              }
            })
            .style('fill', d=> {
              if (currentColor == 'v2paimmig') {
                return immigColor(+d.v2paimmig);
              } else if (currentColor == 'v2xpa_illiberal') {
                return illibColor(+d.v2xpa_illiberal);
              };
            })
            .style('pointer-events', currentHoverFri);

        bubbles_not_fri.transition().duration(1000)
            .style('opacity', currentOpacityNotFri)
            .attr('cy', d=> {
              if (typeof currentYNotFri == 'string') {
                return bubbleIllibY(+d[currentYNotFri]);
              } else {
                return currentYNotFri;
              }
            })
            .style('fill', d=> {
              if (currentColor == 'v2paimmig') {
                return immigColor(+d.v2paimmig);
              } else if (currentColor == 'v2xpa_illiberal') {
                return illibColor(+d.v2xpa_illiberal);
              };
            })
            .style('pointer-events', currentHoverNotFri);



        bubbleTitle.transition().duration(1000)
            .style('opacity', currentOpacityTitle);
        bubbleSubtitle.transition().duration(1000)
            .style('opacity', currentOpacityTitle);

        xAxis.transition().duration(1000)
            .attr("transform", "translate(0," + currentYAxis + ")")
            .style('opacity', currentOpacityCallFri);

        yAxis.transition().duration(1000)
            .style('opacity', function(){
              if (i == 7) {
                return 1;
              } else {
                return 0;
              }
            });

        // draw labels

        partyLabels.transition().duration(1000)
	    	.style('opacity', currentOpacityLabs)
	    	.attr('x', d=> {
	      	if (typeof currentX == 'string') {
	            return bubbleImmigX(+d[currentX]);
	          } else {
	            return currentX;
	          }
	    	})
	    	.attr('y', d=> {
	          if (currentY == 'v2paid') {
	            return yScale(+d[currentY]);
	          } else if (currentY == 'v2xpa_illiberal') {
              return bubbleIllibY(+d[currentY]);
            } else {
	            return currentY;
	          }
	    	});

        countryLabels.transition().duration(1000)
	    	.style('opacity', currentOpacityLabs)
	    	.attr('x', d=> {
	      	if (typeof currentX == 'string') {
	            return bubbleImmigX(+d[currentX]);
	          } else {
	            return currentX;
	          }
	    	})
        .attr('y', d=> {
            if (currentY == 'v2paid') {
              return yScale(+d[currentY]) + 15;
            } else if (currentY == 'v2xpa_illiberal') {
              return bubbleIllibY(+d[currentY]) + 15;
            } else {
              return currentY + 15;
            }
        });
//////
//////
//////
        calloutLabelsFri.transition().duration(1000)
        .style('opacity', currentOpacityCallFri)
        .attr('x', d=> {
          if (i == 7) {
            return bubbleImmigX(+d[currentX]) + bubbleSize(+d.v2pavote) + 4;
          } else if (typeof currentX == 'string') {
            return bubbleImmigX(+d[currentX]) - 2;
          } else {
            return currentX;
          }
        })
        .attr('y', d=> {
          // set a special offset for National Front
          var offset = -54;
          if (+d.v2paid == 433) {
            offset = -70;
          };
          if (currentY == 'v2paid') {
            return yScale(+d[currentY]) + offset; //15 + bubbleSize(+d.v2pavote);
          } else if (currentY == 'v2xpa_illiberal') {
            return bubbleIllibY(+d[currentY]) + 5; //15 + bubbleSize(+d.v2pavote);
          } else {
            return currentY + offset; //15 + bubbleSize(+d.v2pavote);
          }
        });

        calloutLabelsNotFri.transition().duration(1000)
        .style('opacity', currentOpacityCallNotFri)
        .attr('x', d=> {
          if (i == 7) {
            return bubbleImmigX(+d[currentX]) + bubbleSize(+d.v2pavote) + 4;
          } else if (typeof currentX == 'string') {
              return bubbleImmigX(+d[currentX]) - 2;
            } else {
              return currentX;
            }
        })
        .attr('y', d=> {
          // set a special offset for National Front
          var offset = -54;
          if (+d.v2paid == 433) {
            offset = -70;
          };
          if (typeof currentYNotFri == 'string') {
            return bubbleIllibY(+d[currentYNotFri]) + 5; //15 + bubbleSize(+d.v2pavote);
          } else {
            return currentYNotFri + offset; //15 + bubbleSize(+d.v2pavote);
          }
        });
/////
/////
/////
        calloutLinesFri.transition().duration(1000)
        .style('opacity', currentOpacityCallFri)
        .attr('x1', d=> {
          if (typeof currentX == 'string') {
            return bubbleImmigX(+d[currentX]);
          } else {
            return currentX;
          }
        })
        .attr('x2', d=> {
          if (typeof currentX == 'string') {
              return bubbleImmigX(+d[currentX]);
            } else {
              return currentX;
            }
        })
        .attr('y1', d=> {
          if (currentY == 'v2paid') {
            return yScale(+d[currentY]); //15 + bubbleSize(+d.v2pavote);
          } else if (currentY == 'v2xpa_illiberal') {
            return bubbleIllibY(+d[currentY]) + 5; //15 + bubbleSize(+d.v2pavote);
          } else {
            return currentY; //15 + bubbleSize(+d.v2pavote);
          }
        })
        .attr('y2', d=> {
          // set a special offset for National Front
          var offset = -50;
          if (+d.v2paid == 433) {
            offset = -66;
          };
          if (currentY == 'v2paid') {
            return yScale(+d[currentY]) + offset; //15 + bubbleSize(+d.v2pavote);
          } else if (currentY == 'v2xpa_illiberal') {
            return bubbleIllibY(+d[currentY]) + 5; //15 + bubbleSize(+d.v2pavote);
          } else {
            return currentY + offset; //15 + bubbleSize(+d.v2pavote);
          }
        });

        calloutLinesNotFri.transition().duration(1000)
        .style('opacity', currentOpacityCallNotFri)
        .attr('x1', d=> {
          if (typeof currentX == 'string') {
              return bubbleImmigX(+d[currentX]);
            } else {
              return currentX;
            }
        })
        .attr('x2', d=> {
          if (typeof currentX == 'string') {
              return bubbleImmigX(+d[currentX]);
            } else {
              return currentX;
            }
        })
        .attr('y1', d=> {
          if (typeof currentYNotFri == 'string') {
            return bubbleIllibY(+d[currentYNotFri]) + 5; //15 + bubbleSize(+d.v2pavote);
          } else {
            return currentYNotFri; //15 + bubbleSize(+d.v2pavote);
          }
        })
        .attr('y2', d=> {
          // set a special offset for National Front
          var offset = -50;
          if (+d.v2paid == 433) {
            offset = -66;
          };
          if (typeof currentYNotFri == 'string') {
            return bubbleIllibY(+d[currentYNotFri]) + 5; //15 + bubbleSize(+d.v2pavote);
          } else {
            return currentYNotFri + offset; //15 + bubbleSize(+d.v2pavote);
          }
        });
/////
/////
/////
        voteLabels.transition().duration(1000)
        .style('opacity', currentOpacityVote)
        .attr('x', d=> {
          if (typeof currentX == 'string') {
              return bubbleImmigX(+d[currentX]) + 19 + bubbleSize(+d.v2pavote) * 2;
            } else {
              return currentX + 19 + bubbleSize(+d.v2pavote) * 2;
            }
        })
        .attr('y', d=> {
            if (currentY == 'v2paid') {
              return yScale(+d[currentY]) + 4;
            } else if (currentY == 'v2xpa_illiberal') {
              return bubbleIllibY(+d[currentY]) + 4;
            } else {
              return currentY + 4;
            }
        });

        voteTitle.transition().duration(1000)
        .style('opacity', currentOpacityVote);

        plot1Title.transition().duration(1000)
          .style('opacity', currentOpacityPlot1);
        plot2Title.transition().duration(1000)
          .style('opacity', currentOpacityPlot2);
        plot3Title.transition().duration(1000)
          .style('opacity', currentOpacityPlot3);

        plot1Axis.transition().duration(1000)
          .style('opacity', currentOpacityPlot1);
        plot2Axis.transition().duration(1000)
          .style('opacity', currentOpacityPlot2);
        plot3Axis.transition().duration(1000)
          .style('opacity', currentOpacityPlot3);

        plot1Lines.transition().duration(1000)
          .style('opacity', currentOpacityPlot1);
        plot2Lines.transition().duration(1000)
          .style('opacity', currentOpacityPlot2);
        plot3Lines.transition().duration(1000)
          .style('opacity', currentOpacityPlot3);

        plot1ArrowsOuter.transition().duration(1000)
          .style('opacity', currentOpacityPlot1);
        plot2ArrowsOuter.transition().duration(1000)
          .style('opacity', currentOpacityPlot2);
        plot3ArrowsOuter.transition().duration(1000)
          .style('opacity', currentOpacityPlot3);

		    plot1ArrowsInner.transition().duration(1000)
          .style('opacity', currentOpacityPlot1);
        plot2ArrowsInner.transition().duration(1000)
          .style('opacity', currentOpacityPlot2);
        plot3ArrowsInner.transition().duration(1000)
          .style('opacity', currentOpacityPlot3);

    		plot1YearLabels.transition().duration(1000)
    			.style('opacity', currentOpacityPlot1);
    		plot2YearLabels.transition().duration(1000)
    			.style('opacity', currentOpacityPlot2);
    		plot3YearLabels.transition().duration(1000)
    			.style('opacity', currentOpacityPlot3);

        plot1Dots.transition().duration(1000)
          .style('opacity', currentOpacityPlot1);
        plot2Dots.transition().duration(1000)
          .style('opacity', currentOpacityPlot2);
        plot3Dots.transition().duration(1000)
          .style('opacity', currentOpacityPlot3);

        }); // end .on



    d3.select('#source')
        .styles({'margin-bottom': window.innerHeight - 450 + 'px', padding: '100px'})
  }
  render()
  d3.select(window).on('resize', render)

  }); // end d3.csv

</script>
